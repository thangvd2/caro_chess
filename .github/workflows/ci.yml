name: CI/CD

on:
  push:
    branches: [master, thangvd2/**]
  pull_request:
    branches: [master]

jobs:
  # Flutter Lint
  lint-flutter:
    name: Lint Flutter
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.10.7'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze code
        run: flutter analyze

  # Go Lint
  lint-go:
    name: Lint Go
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true
          cache-dependency-path: server/go.sum

      - name: Check formatting
        working-directory: ./server
        run: |
          gofmt -l . | tee fmt.txt
          test -z "$(cat fmt.txt)" || { echo "Code is not formatted. Run 'gofmt .'" >&2; exit 1; }

      - name: Vet code
        working-directory: ./server
        run: go vet ./...

  # Flutter Tests
  test-flutter:
    name: Test Flutter
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.10.7'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test --coverage

  # Go Tests
  test-go:
    name: Test Go
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true
          cache-dependency-path: server/go.sum

      - name: Run tests
        working-directory: ./server
        run: go test -v ./...

  # Build Flutter Web
  build-web:
    name: Build Web
    needs: [lint-flutter, test-flutter]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.10.7'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build web
        run: flutter build web --release

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-release
          path: build/web/
          retention-days: 7

  # Build Android APK
  build-apk:
    name: Build APK
    needs: [lint-flutter, test-flutter]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.10.7'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: apk-release
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 7

  # Build Go Server
  build-server:
    name: Build Server
    needs: [lint-go, test-go]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true
          cache-dependency-path: server/go.sum

      - name: Build server
        working-directory: ./server
        run: go build -o caro_chess_server .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: server-binary
          path: server/caro_chess_server
          retention-days: 7
